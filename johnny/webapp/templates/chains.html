<!doctype html>
<html>

{% include 'head.html' %}

<head>
<script>

  function sumFloat(a, b) { return (parseFloat(a) + parseFloat(b)).toFixed(2); }
  function sumInt(a, b) { return parseInt(a) + parseInt(b); }

  $(document).ready(function() {
      var config = {
          pageLength: 200,
          select: 'multi+shift',
          fixedHeader: true,
          colReorder: true,
          columnDefs: [{
              // TODO(blais): Set this by name (doesn't seem to work).
              // These are the column indices with numbers, to right-align.
              targets: [6,7,8,9,10,11],
              className: 'dt-body-right'
          }],

          // This gets called once when the table is drawn.
          ///footerCallback: function (row, data, start, end, display) {}
      };
      var table = $('#chains').DataTable(config);
      InstallDataTableFocus(table);

      // Emphasize some columns of the table.
      $(table.column(':contains(pnl_chain)').nodes()).addClass('emph-column');

      // TODO(blais): Remove, this was replaced with a link.
      // When the Clear button is pressed, clear the selection.
      $('button#clear').click( function () {
          table.rows('.selected').deselect();
      } );

      // Redirect with a list of the selected chains.
      $('button#names').click( function () {
          var ids = table.rows('.selected').ids().join(",");
          window.open(`/chain_names?chain_ids=${ids}`, '_blank');
      } );
      $('button#stats').click( function () {
          var ids = table.rows('.selected').ids().join(",");
          window.open(`/stats?chain_ids=${ids}`, '_blank');
      } );
      $('button#protos').click( function () {
          var ids = table.rows('.selected').ids().join(",");
          window.open(`/chain_protos?chain_ids=${ids}`, '_blank');
      } );
      $('button#share').click( function () {
          var ids = table.rows('.selected').ids().join(",");
          window.open(`/share?chain_ids=${ids}`, '_blank');
      } );

      // Update the footer sums on a selection change.
      var updateFooter = function(table) {
          const columns = {
              init: sumFloat,
              init_legs: sumInt,
              pnl_chain: sumFloat,
              net_liq: sumFloat,
              commissions: sumFloat,
              fees: sumFloat,
          }
          $.each(columns, function(colname, reducer) {
              var data = table.cells('.selected', ':contains(' + colname + ')').data();
              var column = table.column(':contains(' + colname + ')');
              if (data.length == 0) {
                  $(column.footer()).html('');
                  return;
              }
              var sum = data.reduce(reducer);
              $(column.footer()).html(sum);
          });
      };
      table.on('select.dt', function () {
          updateFooter(table);
      });
      table.on('deselect.dt', function () {
          updateFooter(table);
      });
  });

</script>
</head>

<body>
{% include 'navigation.html' %}
<button id="clear">Clear</button>
<button id="names">Names</button>
<button id="stats">Stats</button>
<button id="protos">Protos</button>
<button id="share">Share</button>

{{ table|safe }}
<body>

</html>
