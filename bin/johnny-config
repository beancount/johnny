#!/usr/bin/env python3
"""Read and clean up the configuration.

This tool reads the database and removes invalid chains, insert missing ones,
and prints out the corrected configuration. You can then edit this manually.
"""
__copyright__ = "Copyright (C) 2021  Martin Blais"
__license__ = "GNU GPLv2"

import copy
import logging
from typing import List, Optional

import click

from johnny.base import discovery
from johnny.base import mark
from johnny.base import instrument
from johnny.base.etl import petl, Table
from johnny.base import config as configlib
from johnny.base import chains as chainslib


@click.command()
@click.argument('config_filename', type=click.Path(exists=True))
@click.option('--ledger', '-l', type=click.Path(exists=False),
              help="Remove transactions from Ledger. Requires order ids.")
def chains(config_filename: str,
           ledger: Optional[str]):
    "Find, process and print positions."

    config = configlib.ParseFile(config_filename)
    transactions = petl.frompickle(config.output.imported_filename)

    # Mark the transactions.
    price_map = mark.GetPriceMap(transactions, config)
    transactions = mark.Mark(transactions, price_map)

    # Compute the chains.
    chains = chainslib.TransactionsToChains(transactions)
    table_chain_ids = set(chains.values('chain_id'))

    # A copy of the original proto, to be cleaned up.
    chain_map = {chain.chain_id: chain for chain in config.chains}

    # Produce a clean output proto with existing chains.
    clean = copy.copy(config)
    clean.ClearField('chains')
    for chain_id in sorted(table_chain_ids):
        new_chain = clean.chains.add()
        chain = chain_map.pop(chain_id, None)
        if chain is None:
            # Create a new chain that wasn't present in the original list.
            new_chain.chain_id = chain_id
        else:
            new_chain.MergeFrom(chain)

    # Add residual chains.
    clean.ClearField('residual_chains')
    for chain in chain_map.values():
        new_chain = clean.chains.add()
        new_chain.MergeFrom(chain)

    print(clean)


if __name__ == '__main__':
    chains()
