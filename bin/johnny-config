#!/usr/bin/env python3
"""Read and clean up the configuration.

This tool reads the database and removes invalid chains, insert missing ones,
and prints out the corrected configuration. You can then edit this manually.
"""
__copyright__ = "Copyright (C) 2021  Martin Blais"
__license__ = "GNU GPLv2"

import copy
import logging
from typing import List, Optional

import click

from johnny.base import discovery
from johnny.base import mark
from johnny.base import instrument
from johnny.base.etl import petl, Table
from johnny.base import config as configlib
from johnny.base import chains as chainslib


@click.command()
@click.option('--config', '-c', type=click.Path(exists=True),
              help="Configuration filename. Default to $JOHNNY_CONFIG")
def chains(config: Optional[str]):
    "Find, process and print positions."

    filename = configlib.GetConfigFilenameWithDefaults(config)
    config = configlib.ParseFile(filename)
    transactions = petl.frompickle(config.output.imported_filename)
    chains = chainslib.TransactionsTableToChainsTable(transactions, config)

    clean_config = chainslib.CleanConfig(config, chains, transactions)
    print(clean_config)


if __name__ == '__main__':
    chains()
