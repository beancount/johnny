#!/usr/bin/env python3
"""Recomputate the chains and produce the updated configuration.

This tool reads the imported database and recomputes the chains clustering,
producing an updated configuration file. You can then edit this manually and use
it on further runs.
"""

__copyright__ = "Copyright (C) 2021  Martin Blais"
__license__ = "GNU GPLv2"

import copy
import logging
from typing import List, Optional

import click

from johnny.base import discovery
from johnny.base import mark
from johnny.base import instrument
from johnny.base.etl import petl, Table
from johnny.base import config as configlib
from johnny.base import chains as chainslib


@click.command()
@click.option('--config', '-c', type=click.Path(exists=True),
              help="Configuration filename. Default to $JOHNNY_CONFIG")
def chains(config: Optional[str]):
    filename = configlib.GetConfigFilenameWithDefaults(config)
    config = configlib.ParseFile(filename)
    mtransactions = (petl.frompickle(config.output.imported_filename)
                     .cutout('chain_id'))
    ctransactions, cconfig = chainslib.ChainTransactions(mtransactions, config)
    print(configlib.ToText(cconfig))


if __name__ == '__main__':
    chains()
