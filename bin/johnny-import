#!/usr/bin/env python3
"""Import new transactions from sources into our local database.

This tool reads a configuration file with a specification for transactions and
positions input sources for each account, normalizes them, runs the chains
processing code and ingests them everything to its own local database of
normalized and matched transactions. The local database is the source of data
for various tools, such as Johnny's trade log and eventually monitoring tools as
well. This is intended to be runnable mid-day.
"""

__copyright__ = "Copyright (C) 2021  Martin Blais"
__license__ = "GNU GPLv2"

import logging
from typing import List, Optional

import click

from johnny.base import chains
from johnny.base import config as configlib
from johnny.base import discovery
from johnny.base import instrument
from johnny.base import match2
from johnny.base.etl import Table


def ImportTransactions(config: configlib.Config) -> Table:
    """Read transactions, and do all necessary processing."""

    # Extract the explicit chains.
    transactions_chain_map, orders_chain_map = configlib.GetExplicitChains(config)

    # Extract the explicit transsaction and order links.
    transaction_links = [list(links.ids) for links in config.transaction_links]
    order_links = [list(links.ids) for links in config.order_links]

    # # Extract the price db to be used for opening positions.
    # price_db = configlib.GetPriceDB(config)

    # Read the inputs.
    logtables = discovery.ReadConfiguredInputs(config)
    transactions = logtables[configlib.Account.LogType.TRANSACTIONS]

    # TODO(blais): Continue here

    # Synthesize opening balances. We need to temporarily expand the instrument
    # fields, as they are needed by the match and chains modules.
    transactions = (transactions
                    .applyfn(match2.Process)
                    #.applyfn(instrument.Expand, 'symbol')
                    # .applyfn(chains.Group,
                    #          explicit_transactions_chain_map=transactions_chain_map,
                    #          explicit_orders_chain_map=orders_chain_map,
                    #          transaction_links=transaction_links,
                    #          order_links=order_links)
                    #.applyfn(instrument.Shrink)
                    )

    print(transactions.lookallstr())


@click.command()
@click.argument('config_filename', type=click.Path(exists=True))
@click.option('--opening_filename', type=click.Path(exists=True),
              help=("CSV filename with opening positions. "
                    "See ReadOpeningPositions() for details"))
def import_(config_filename: str, opening_filename: str):
    config = configlib.ParseFile(config_filename)
    ImportTransactions(config)



if __name__ == '__main__':
    import_()
